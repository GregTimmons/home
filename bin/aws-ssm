#!/bin/bash

function listEc2() {
	aws ec2 describe-instances --query "Reservations[*].Instances[*].[Tags[?Key=='Name'].Value, InstanceId, PublicDnsName]" \
			| jq 'flatten[]' \
			| sed 's/"//g' \
			| awk '
					BEGIN { K=0 }
					{ 
						if (NR % 3 == 1) {
							printf("%d)%s", K, $1)
							K++
						} else if (NR % 3 == 2) {
							printf("|%s", $1)
				  	} else {
							printf("|%s\n", $1)
				  	}
					}
				'
}

#!/usr/bin/env bash
. ~/bin/select_options.sh
VALUE=$1
if [ -z "$VALUE" ]; then 
   OPTIONS_STRING=$(listEc2)
   readarray -t OPTIONS <<<"${OPTIONS_STRING}"
   select_option "${OPTIONS[@]}"
   CHOICE=$?
   VALUE=${OPTIONS[$CHOICE]}
fi
aws ssm start-session --target $(echo $VALUE | sed 's/|/ /g' | awk '{ print $2 }') 
